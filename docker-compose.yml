version: "3"
services:
  app: &app
    build: .
    image: keboola/db-extractor-pgsql
    command: composer ci
    environment:
      - PGSQL_DB_HOST=pgsql
      - PGSQL_DB_PORT=5432
      - PGSQL_DB_DATABASE=postgres
      - PGSQL_DB_USER=postgres
      - PGSQL_DB_PASSWORD=some password
    volumes:
      - ./docker/pgsql/certificates:/ssl-cert:z
      - ssh-keys:/root/.ssh:ro
    links:
      - pgsql
      - sshproxy

  dev:
    <<: *app
    volumes:
      - .:/code
      - ./data:/data
      - ./docker/pgsql/certificates:/ssl-cert:z
      - ssh-keys:/root/.ssh:ro,z

  pgsql:
    build:
      args:
        version: ${PGSQL_VERSION}
      context: ./docker/pgsql
    image: keboola/pgsql-test
    command: -c ssl=on -c ssl_cert_file=/ssl-cert/server.crt -c ssl_key_file=/ssl-cert/server.key
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=some password

  wait:
    image: waisbrot/wait
    depends_on:
      - pgsql
    environment:
      - TARGETS=pgsql:5432
      - TIMEOUT=200

  sshproxy:
    image: keboola/db-component-ssh-proxy:latest
    volumes:
      - ssh-keys:/root/.ssh:z
    links:
      - pgsql

volumes:
  ssh-keys:
